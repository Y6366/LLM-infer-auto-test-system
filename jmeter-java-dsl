ğŸ§© ä¸€ã€JMeter Java DSL ç®€ä»‹

jmeter-java-dsl æ˜¯ç”± Abstracta å¼€æºçš„ä¸€ä¸ª DSLï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰åº“ï¼Œè®©ä½ ç”¨ Java ä»£ç ç›´æ¥æè¿° JMeter è„šæœ¬ï¼Œè€Œä¸æ˜¯ç»´æŠ¤å¤æ‚çš„ .jmx æ–‡ä»¶ã€‚

å®ƒçš„æ ¸å¿ƒç†å¿µæ˜¯ï¼š

â€œè®©æ€§èƒ½æµ‹è¯•åƒå•å…ƒæµ‹è¯•ä¸€æ ·ç¼–å†™å’Œè¿è¡Œã€‚â€

ä¸»è¦ç‰¹æ€§ï¼š
	â€¢	æ— éœ€ JMeter GUIï¼›
	â€¢	è‡ªåŠ¨ç®¡ç†çº¿ç¨‹ç»„ã€é‡‡æ ·å™¨ã€å®šæ—¶å™¨ã€æ–­è¨€ï¼›
	â€¢	æ”¯æŒæ‰€æœ‰å¸¸è§ JMeter åŠŸèƒ½ï¼›
	â€¢	å¯åœ¨ IDE æˆ– CI ä¸­è¿è¡Œï¼›
	â€¢	å¯ç›´æ¥ç”Ÿæˆ .jmx æ–‡ä»¶å’Œ HTML æŠ¥å‘Šã€‚

â¸»

âš™ï¸ äºŒã€åŸºç¡€ç»“æ„

åœ¨ DSL ä¸­ï¼Œä¸€ä¸ªå®Œæ•´çš„æµ‹è¯•è„šæœ¬é€šå¸¸åŒ…å«ä¸‰å±‚ç»“æ„ï¼š
testPlan(
  threadGroup()
    .children(
       httpSampler("path").method("GET"),
       responseAssertion().containsSubstrings("OK")
    ),
  summaryStats() // æ§åˆ¶å°æ±‡æ€»è¾“å‡º
).run();

å±‚çº§
è¯´æ˜
testPlan()
é¡¶å±‚å®¹å™¨ï¼Œç­‰ä»·äº JMeter çš„ Test Plan
threadGroup()
çº¿ç¨‹ç»„ï¼ˆå¹¶å‘ç”¨æˆ·ã€RampUpã€å¾ªç¯æ¬¡æ•°ï¼‰
.children()
çº¿ç¨‹ç»„å†…çš„è¯·æ±‚ã€é…ç½®ã€å®šæ—¶å™¨ã€æ–­è¨€ç­‰
httpSampler()
è¯·æ±‚å®šä¹‰ï¼ˆURLã€æ–¹æ³•ã€Headerã€Bodyï¼‰
assertion()
å“åº”æ–­è¨€ï¼ˆå†…å®¹ã€æ—¶é•¿ã€çŠ¶æ€ç ï¼‰
summaryStats()
ç»“æœæ±‡æ€»ç›‘å¬å™¨ï¼ˆç­‰ä»· GUI çš„â€œæ±‡æ€»æŠ¥å‘Šâ€ï¼‰


ä¸‰ã€æ ¸å¿ƒç»„ä»¶ä¸æ–¹æ³•è¯¦è§£

1ï¸âƒ£ Test Planï¼ˆæµ‹è¯•è®¡åˆ’ï¼‰
testPlan(children...)         // å®šä¹‰æ•´ä¸ªè®¡åˆ’
testPlan(threads, rampUp, duration) // å¯åŒæ—¶è®¾ç½®çº¿ç¨‹å‚æ•°

è¿˜å¯åµŒå¥—å¤šä¸ª threadGroup æˆ– backendListenerã€‚


ã€‚

â¸»

2ï¸âƒ£ Thread Groupï¼ˆçº¿ç¨‹ç»„ï¼‰

threadGroup()
  .rampToAndHold(200, Duration.ofSeconds(60), Duration.ofMinutes(5)) // 60så†…å‡åˆ°200çº¿ç¨‹å¹¶æŒç»­5åˆ†é’Ÿ
  .children(...);

å…¶ä»–å¯ç”¨æ–¹æ³•ï¼š
threadGroup("name", 100, Duration.ofSeconds(30), children...) // æŒ‡å®šçº¿ç¨‹æ•°ä¸å‡æ¸©æ—¶é—´
rampToAndHold()            // GUI â€œé˜¶æ¢¯å¼åŠ å‹â€
holdFor(Duration.ofMinutes(3))
rampDownTo(0, Duration.ofSeconds(30))

çº¿ç¨‹ç»„æ–¹æ³•å®Œå…¨ç­‰ä»·äº GUI ä¸­çš„ã€Œçº¿ç¨‹ç»„ã€ã€ã€Œå¹¶å‘çº¿ç¨‹ç»„ã€ã€‚

HTTP Samplerï¼ˆè¯·æ±‚ï¼‰

httpSampler("/api/login")
  .method("POST")
  .body("{\"user\":\"admin\",\"pass\":\"123\"}")
  .header("Content-Type", "application/json")
  .header("Authorization", "Bearer token")
  .timeout(Duration.ofSeconds(10));
æˆ–æŒ‡å®šå®Œæ•´ URLï¼š

httpDefaults().url("https://example.com")
httpSampler("/api/health")

é€šè¿‡ httpDefaults() è®¾ç½®å…¨å±€ BaseURLã€Headerã€Cookieã€‚

Config å…ƒä»¶
	â€¢	HTTP Defaults

httpDefaults().url("https://api.test.com")

HTTP Headers

httpHeaders().header("User-Agent", "JMeter-DSL")

CSV Data Set

csvDataSet("data.csv").variableNames("user,password")

Cookies / Cache

httpCookies()
httpCache()


â¸»

5ï¸âƒ£ Timerï¼ˆå®šæ—¶å™¨ï¼‰

constantTimer(200)              // å›ºå®šå»¶è¿Ÿ 200ms
uniformRandomTimer(200, 500)    // éšæœºå»¶è¿Ÿ [200,700]ms
constantThroughputTimer(100)    // ä¿æŒæ’å®šååé‡ 100 RPS

6ï¸âƒ£ Controllersï¼ˆé€»è¾‘æ§åˆ¶å™¨ï¼‰
ifController("vars.get('token') != null")
  .children(httpSampler("/secured"))

loopController(5)
  .children(httpSampler("/ping"))

ç­‰ä»·äº GUI ä¸­çš„ If Controllerã€Loop Controller ç­‰ã€‚


7ï¸âƒ£ Pre/Post Processorsï¼ˆå‰åç½®å¤„ç†å™¨ï¼‰

jsr223PreProcessor("vars.put('ts', System.currentTimeMillis()+'')")
jsr223PostProcessor("log.info('Response:' + prev.getResponseDataAsString())")

regexExtractor("token", "\"token\":\"(.+?)\"") // æå– JSON ä¸­çš„ token
jsonExtractor("id", "$.data.id")


â¸»

8ï¸âƒ£ Assertionsï¼ˆæ–­è¨€ï¼‰

responseAssertion()
  .containsSubstrings("success") // å†…å®¹æ–­è¨€
  .testField(ResponseField.RESPONSE_CODE)
  .equalsTo("200")

durationAssertion().durationLessThan(2000) // å“åº”æ—¶é—´ < 2s

9ï¸âƒ£ Listenersï¼ˆç›‘å¬å™¨ï¼‰

summaryStats()                             // æ§åˆ¶å°èšåˆæŠ¥å‘Š
backendListener(BackendListenerType.INFLUX_DB_V2)
  .url("http://influxdb:8086")
  .organization("demo")
  .bucket("jmeter")
  .token("my-token");

æˆ–è¾“å‡ºå®Œæ•´ HTML æŠ¥å‘Šï¼š

var stats = testPlan(...).run();
stats.saveHtmlReport("target/jmeter-report");

ğŸ”Ÿ æ‰§è¡Œä¸ç»“æœå¯¹è±¡

var stats = testPlan(...).run();
System.out.println("Total samples: " + stats.overall().samplesCount());
System.out.println("Errors: " + stats.overall().errorsCount());
System.out.println("Throughput: " + stats.overall().throughput());

ç»“æœå¯¹è±¡ stats å…è®¸ï¼š
	â€¢	stats.overall() â†’ å…¨å±€ç»Ÿè®¡
	â€¢	stats.byLabel("æ¥å£å") â†’ å•æ¥å£ç»Ÿè®¡
	â€¢	å¯¼å‡ºæŠ¥å‘Šï¼šstats.saveAsJtl("results.jtl")


äº”ã€å®Œæ•´ç¤ºä¾‹ï¼ˆç­‰ä»·äº GUI å¤åˆè„šæœ¬ï¼‰

import static us.abstracta.jmeter.javadsl.JmeterDsl.*;
import java.time.Duration;

public class DslPerfTest {
  public static void main(String[] args) throws Exception {
    var stats = testPlan(
        httpDefaults().url("https://api.example.com"),
        threadGroup("User Flow", 100, Duration.ofSeconds(30))
            .rampToAndHold(100, Duration.ofSeconds(30), Duration.ofMinutes(3))
            .children(
                csvDataSet("users.csv").variableNames("user,password"),
                httpSampler("/login")
                    .method("POST")
                    .body("{\"user\":\"${user}\",\"password\":\"${password}\"}")
                    .header("Content-Type", "application/json"),
                jsonExtractor("token", "$.token"),
                ifController("vars.get('token') != null")
                    .children(
                        httpSampler("/data")
                            .header("Authorization", "Bearer ${token}")
                    ),
                uniformRandomTimer(200, 500),
                responseAssertion().containsSubstrings("OK")
            ),
        summaryStats()
    ).run();

    stats.saveAsJtl("target/jmeter/results.jtl");
    stats.saveHtmlReport("target/jmeter/report");
  }
}

âœ… è¿™æ®µä»£ç ç­‰ä»·äº JMeter GUI è„šæœ¬ï¼š
	â€¢	ç”¨æˆ·ç™»å½• + æå– tokenï¼›
	â€¢	æºå¸¦ token è°ƒç”¨ä¸šåŠ¡æ¥å£ï¼›
	â€¢	éšæœºç­‰å¾…ï¼›
	â€¢	éªŒè¯å“åº”ä¸­åŒ…å« â€œOKâ€ï¼›
	â€¢	è¾“å‡ºèšåˆæŠ¥å‘Šä¸ HTMLã€‚

å…­ã€å®æˆ˜ç”¨æ³•å»ºè®®

ç›®æ ‡
æ–¹æ³•
å¿«é€Ÿç¼–å†™å°åœºæ™¯
åœ¨å•å…ƒæµ‹è¯•ç±»ä¸­ç”¨ @Test + DSL
CI è‡ªåŠ¨åŒ–å‹æµ‹
mvn test -Pperf
å‹æµ‹ç»“æœå…¥åº“
ç”¨ stats.overall() æå–æŒ‡æ ‡å†™å…¥ Prometheus/DB
å…¼å®¹ GUI
.saveAsJmx("plan.jmx") å¯¼å‡ºä¸º JMeter å¯è§†åŒ–æ–‡ä»¶
å®æ—¶ç›‘æ§
backendListener(INFLUX_DB_V2) + Grafana



DSL ä¸ GUI å¯¹ç…§è¡¨

GUI å…ƒä»¶
Java DSL å¯¹åº”æ–¹æ³•
Test Plan
testPlan()
Thread Group
threadGroup(), rampToAndHold()
HTTP Request
httpSampler()
CSV Data Set Config
csvDataSet()
Uniform Random Timer
uniformRandomTimer()
Constant Throughput Timer
constantThroughputTimer()
Response Assertion
responseAssertion()
If Controller
ifController()
JSR223 Pre/Post Processor
jsr223PreProcessor(), jsr223PostProcessor()
Regex Extractor
regexExtractor()
Summary Report
summaryStats()
Backend Listener
backendListener()



çŸ­ç­”æ¡ˆï¼š**ä¼šæœ‰é£é™©ã€‚**å¦‚æœæŠŠ JMeter è·‘åœ¨ä¸ä½ çš„ Spring Cloud æœåŠ¡â€œåŒ JVM / åŒ Pod / åŒä¸»æœºâ€ï¼Œæˆ–æŠŠå‹æµ‹æµé‡ç›´æ¥æ‰“åœ¨ç”Ÿäº§é“¾è·¯ä¸Šï¼Œä¸€æ—¦ JMeter æ‰§è¡Œå¼‚å¸¸ï¼ˆè„šæœ¬æ­»å¾ªç¯ã€çº¿ç¨‹æš´æ¶¨ã€è¿æ¥æ³„æ¼ã€è´Ÿè½½å¤±æ§ï¼‰ï¼Œå°±å¯èƒ½æŠŠå½“å‰æœåŠ¡å’Œå…¶ä¸‹æ¸¸ä¸€èµ·æ‹–å®ã€‚
å®‰å…¨åšæ³•æ˜¯ï¼šå‹æµ‹ä¾§ä¸è¢«æµ‹ä¾§å¼ºéš”ç¦»ï¼ˆè¿›ç¨‹/ä¸»æœº/ç½‘ç»œ/æ•°æ®/æƒé™å…¨éš”ç¦»ï¼‰ï¼Œå¹¶åœ¨æœåŠ¡ä¾§å¯ç”¨â€œç†”æ–­/é™æµ/éš”èˆ±/è¶…æ—¶/é‡è¯•ä¸Šé™â€ç­‰ä¿æŠ¤ï¼Œè®¾ç½®â€œæ‹‰é—¸â€ä¸è‡ªåŠ¨å›æ»šæœºåˆ¶ã€‚

ä¸‹é¢æŒ‰â€œé£é™© â†’ è§¦å‘åŸå›  â†’ è§„é¿åŠæ³•â€ç»™ä½ ä¸€ä»½å¯è½åœ°æ¸…å•ï¼ˆå« Spring Cloud/Boot å¸¸ç”¨é…ç½®ç‰‡æ®µï¼‰ã€‚

â¸»

ä¸€ã€å…¸å‹é£é™©é¢

1) æ¶æ„/èµ„æºé£é™©ï¼ˆæœ€å…³é”®ï¼‰
	â€¢	åŒè¿›ç¨‹/åŒæœºè¿è¡Œï¼šæŠŠ JMeter å†…åµŒåˆ° Spring Bootï¼ˆæˆ–ä¸æœåŠ¡åŒ Pod/VMï¼‰â†’ äº‰æŠ¢ CPU/å†…å­˜/FDã€å¼•å‘ GC æŠ–åŠ¨ã€ç±»è·¯å¾„/æ—¥å¿—å†²çªã€å¼‚å¸¸å´©è¿›ç¨‹ã€‚
	â€¢	è´Ÿè½½å¤±æ§ï¼šçº¿ç¨‹ç»„é…ç½®é”™è¯¯ï¼ˆ0 ramp-upã€æ— é™å¾ªç¯ã€Constant Throughput è®¾ç½®è¿‡é«˜ï¼‰â†’ â€œå°–å³°é£æš´â€ã€‚
	â€¢	è¿æ¥/ç«¯å£è€—å°½ï¼šKeep-Alive ä¸é«˜å¹¶å‘å¯¼è‡´ è¿æ¥æ•° æˆ– ephemeral portã€æ–‡ä»¶æè¿°ç¬¦è€—å°½ã€‚
	â€¢	æ—¥å¿—æ”¾å¤§ä¸ç£ç›˜ I/Oï¼šDEBUG çº§åˆ«æˆ–å¤§å“åº”ä½“æ—¥å¿— â†’ I/O æ‰“æ»¡ã€‚

è§„é¿
	â€¢	ç»ä¸åœ¨è¢«æµ‹æœåŠ¡å†…åµŒ JMeterï¼›JMeter ç‹¬ç«‹èŠ‚ç‚¹/Jobï¼Œä¸è¢«æµ‹æœåŠ¡åˆ†é›†ç¾¤ã€åˆ† VPC/å‘½åç©ºé—´ã€åˆ†ä¸»æœºã€‚
	â€¢	ç»™ JMeter/æœåŠ¡éƒ½è®¾ CPU/å†…å­˜é™é¢ ä¸ ulimit -nï¼›ä¸¤è¾¹ JVM å›ºå®šå †ï¼ˆ-Xms = -Xmxï¼‰ï¼Œé¿å…åŠ¨æ€æ‰©å®¹å¯¼è‡´åœé¡¿ã€‚
	â€¢	ä½¿ç”¨ æ¸è¿›åŠ å‹ï¼ˆé˜¶æ¢¯æˆ– rampToAndHoldï¼‰ï¼Œè®¾ç½®æœ€å¤§å¹¶å‘ä¸æœ€ä¹…æŒç»­æ—¶é—´ï¼›è„šæœ¬å†…æ”¾ â€œæ‹‰é—¸â€ï¼ˆè§æœ«å°¾ï¼‰ã€‚
	â€¢	å…³é—­æˆ–é‡‡æ ·åŒ–ä¸šåŠ¡æ—¥å¿—ï¼›å‹æµ‹ç¯å¢ƒç¦ç”¨å¤§ä½“é‡å®¡è®¡/SQL traceã€‚

2) çº§è”ä¸ç¨³æ€é£é™©ï¼ˆSpring Cloud åœºæ™¯ï¼‰
	â€¢	é‡è¯•é£æš´ï¼šFeign/RestTemplate/WebClient æœªé™é‡è¯• â†’ ä¸‹æ¸¸æŠ–åŠ¨æ—¶æ”¾å¤§è¯·æ±‚ã€‚
	â€¢	æ— è¶…æ—¶/å¤ªé•¿è¶…æ—¶ï¼šçº¿ç¨‹é˜»å¡å †ç§¯ï¼Œè§¦å‘â€œé›ªå´©â€ã€‚
	â€¢	æ— éš”èˆ±/é™æµï¼šçƒ­ç‚¹æ¥å£æŠŠä¸šåŠ¡çº¿ç¨‹/è¿æ¥æ± åƒå…‰ï¼Œå…¶ä»–æ¥å£â€œé¥¿æ­»â€ã€‚
	â€¢	ç†”æ–­ç¼ºå¤±ï¼šå¤±è´¥æ¯”ç‡ä¸Šå‡ä»æŒç»­æ”¾é‡ï¼Œæ‰©å¤§æŸå¤±ã€‚
	â€¢	æ³¨å†Œå‘ç°/ç½‘å…³ï¼šGateway è§„åˆ™ç¼ºçœã€è´Ÿè½½ä¸å‡ã€ä¼šè¯ç²˜æ»å¯¼è‡´å•å®ä¾‹è¢«æ‰“çˆ†ã€‚

è§„é¿ï¼ˆé…ç½®ç¤ºä¾‹ï¼‰
Resilience4jï¼ˆæ¨èï¼‰

resilience4j:
  timeLimiter:
    instances.default.timeoutDuration: 2s
  circuitbreaker:
    instances.default:
      slidingWindowType: COUNT_BASED
      slidingWindowSize: 100
      failureRateThreshold: 50
      slowCallDurationThreshold: 2s
      slowCallRateThreshold: 50
      waitDurationInOpenState: 10s
  bulkhead:
    instances.default:
      maxConcurrentCalls: 200
      maxWaitDuration: 0
  ratelimiter:
    instances.default:
      limitForPeriod: 1000   # æ¯ç§’å…è®¸é‡
      limitRefreshPeriod: 1s
      timeoutDuration: 0

Feign è¶…æ—¶/é‡è¯•ä¸Šé™

feign:
  client:
    config:
      default:
        connectTimeout: 2000
        readTimeout: 2000
        loggerLevel: basic
# å¦‚ä½¿ç”¨ Resilience4j Retryï¼Œå‹æµ‹æ—¶å¯é™åˆ° 1 æ¬¡ï¼Œé¿å…æ”¾å¤§æŠ–åŠ¨
resilience4j.retry.instances.default.maxAttempts: 1

Tomcatï¼ˆServlet æ ˆï¼‰çº¿ç¨‹/è¿æ¥ä¸Šé™

server:
  tomcat:
    max-threads: 200
    accept-count: 100
    max-connections: 10000

WebClientï¼ˆReactor Netty å®¢æˆ·ç«¯æ± /è¶…æ—¶ï¼‰

@Bean
WebClient webClient() {
  ConnectionProvider provider = ConnectionProvider.builder("fixed")
      .maxConnections(500)
      .pendingAcquireMaxCount(1000)
      .build();
  HttpClient http = HttpClient.create(provider)
      .responseTimeout(Duration.ofSeconds(2));
  return WebClient.builder()
      .clientConnector(new ReactorClientHttpConnector(http))
      .build();
}

Gateway é™æµï¼ˆç¤ºä¾‹ï¼šRedis RateLimiterï¼‰

spring:
  cloud:
    gateway:
      routes:
        - id: api
          uri: http://svc
          predicates: [ Path=/api/** ]
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200


3) æ•°æ®ä¸å‰¯ä½œç”¨é£é™©
	â€¢	å‹æµ‹è„šæœ¬è¯¯æ‰“ ç”Ÿäº§æ•°æ®åº“/æ”¯ä»˜/ä¸‹å• æ¥å£ï¼Œé€ æˆçœŸå®å‰¯ä½œç”¨æˆ–æ•°æ®æ±¡æŸ“ã€‚
	â€¢	ä½¿ç”¨çœŸå®è´¦å·/PII/Token æ³„æ¼åˆè§„é£é™©ã€‚
	â€¢	çƒ­ç‚¹é”®/åˆ†åŒºè¢«æ‰“ç©¿ï¼Œå¼•å‘ ç¼“å­˜é›ªå´©/å‡»ç©¿ã€DB çƒ­ç‚¹é”ã€‚

è§„é¿
	â€¢	åªåœ¨å‹æµ‹ç¯å¢ƒï¼›å¼ºåˆ¶æ‰€æœ‰å†™æ“ä½œæ‰“åˆ° å½±å­åº“/å½±å­è¡¨ æˆ–ä½¿ç”¨ å¹‚ç­‰ & å›æ»šæ•°æ®ã€‚
	â€¢	ç»Ÿä¸€ â€œå‹æµ‹å‡­æ®/ç§Ÿæˆ·/Header æ ‡è¯†â€ï¼ˆå¦‚ X-Perf-Run: trueï¼‰ï¼Œç½‘å…³æˆ–æœåŠ¡è¯†åˆ«åèµ°â€œå½±å­é€»è¾‘â€ã€‚
	â€¢	å‡†å¤‡åˆæˆæ•°æ®ï¼ˆCSV/Mockï¼‰ï¼Œè¦†ç›–çœŸå®åˆ†å¸ƒï¼›éšæœºåŒ– Keyï¼Œé¿å…çƒ­ç‚¹ã€‚

4) ç½‘ç»œä¸åŸºç¡€è®¾æ–½é£é™©
	â€¢	NAT/è´Ÿè½½å‡è¡¡è¿æ¥/ç«¯å£æ‰“æ»¡ï¼›
	â€¢	è§‚æµ‹ç³»ç»Ÿè¢«å‹å®ï¼ˆå¤§é‡æŒ‡æ ‡/traceï¼‰åå‘å½±å“ä¸šåŠ¡ã€‚

è§„é¿
	â€¢	JMeter ä¾§ åˆ†å¸ƒå¼å‘å‹ï¼ˆå¤šå‘å‹æœºã€å°±è¿‘å¤š AZï¼‰ï¼›é™åˆ¶æ¯æœºå¹¶å‘ä¸ Keep-Aliveã€‚
	â€¢	è§‚æµ‹é‡‡æ ·ç‡é™æµï¼ˆTracing é‡‡æ · < 10%ï¼‰ï¼ŒæŒ‡æ ‡æ±‡æŠ¥æ‰¹é‡/é™é¢‘ï¼›Grafana/TSDB ç‹¬ç«‹é›†ç¾¤ã€‚


äºŒã€â€œæ‰§è¡Œå¼‚å¸¸â€å¯¼è‡´å½±å“çš„å…¸å‹åœºæ™¯ä¸å¤„ç½®


å¼‚å¸¸åœºæ™¯ï¼ˆJMeter ä¾§ï¼‰
å¯èƒ½å½±å“
é˜²æŠ¤/å¤„ç½®
è„šæœ¬æ­»å¾ªç¯ã€0 RampUpã€è¯¯é… TPS
ç¬æ—¶å°–å³°å‹çˆ†æœåŠ¡
è„šæœ¬åŠ  Scheduler ç»“æŸæ—¶é—´ã€çº¿ç¨‹ä¸Šé™ã€é˜¶æ¢¯åŠ å‹ï¼›æœåŠ¡ä¾§é™æµ/éš”èˆ±ï¼›CI/CD åŠ â€œå®¡æ‰¹é—¸â€
è¿æ¥æ³„æ¼/å¤ªå¤šé•¿è¿æ¥
æœåŠ¡å™¨è¿æ¥/ç«¯å£è€—å°½
JMeter å¯ç”¨ Keep-Alive ä½†é™å¹¶å‘ï¼›æœåŠ¡ä¾§ max-connections ä¸Šé™ä¸é˜Ÿåˆ—ä¿æŠ¤
ç»“æœç›‘å¬å™¨/æ–­è¨€å¼‚å¸¸ï¼Œæœªæ­£å¸¸æ”¶å°¾
æµ‹è¯•æœªåœæ­¢ã€æŒç»­æ–½å‹
ç»™ JMeter é… å¤–éƒ¨â€œæ‹‰é—¸â€ï¼ˆè§ä¸‹ï¼‰ä¸è¶…æ—¶ï¼›K8s Job/TTL è‡ªåŠ¨æ¸…ç†
JMeter OOM/CPU é£™é«˜
å‘å‹ç«¯æ‰çº¿/æŠ–åŠ¨ï¼Œè´Ÿè½½æ›²çº¿å¼‚å¸¸


æ‹‰é—¸ï¼ˆç«‹å³åœæ­¢ï¼‰
	â€¢	é¢„ç½®ç®¡æ§ï¼šè¿è¡Œæ—¶å¯ç”¨ Scheduler æˆªæ­¢æ—¶é—´ï¼›
	â€¢	å¤–éƒ¨å‘½ä»¤ï¼šshutdownï¼ˆä¼˜é›…åœæ­¢ï¼‰ / stoptestï¼ˆç«‹å³åœæ­¢ï¼‰ï¼›
	â€¢	åœ¨è„šæœ¬é‡Œé¢„ç•™ Test Action â†’ Stop Now å¯è¢«è¿œç¨‹è§¦å‘ï¼ˆå¦‚ CI æ­¥éª¤æˆ– webhookï¼‰ã€‚

â¸»

ä¸‰ã€å‹æµ‹â€œå®‰å…¨å§¿åŠ¿â€æœ€å°é—­ç¯ï¼ˆå¯ç›´æ¥æ‰§è¡Œï¼‰
	1.	æ‹“æ‰‘éš”ç¦»ï¼šJMeter åœ¨ç‹¬ç«‹é›†ç¾¤/å‘½åç©ºé—´ï¼›è¢«æµ‹æœåŠ¡åœ¨ perf ç¯å¢ƒï¼›ç½‘å…³ç­–ç•¥åªå…è®¸æ¥è‡ªå‘å‹ç½‘æ®µã€‚
	2.	æœåŠ¡ä¿æŠ¤ï¼šæŒ‰ä¸Šæ–‡å¯ç”¨ è¶…æ—¶ã€ç†”æ–­ã€éš”èˆ±ã€é™æµï¼›å…³é—­é‡è¯•æˆ–ä¸¥æ ¼ä¸Šé™ã€‚
	3.	æ•°æ®å®‰å…¨ï¼šå½±å­æ•°æ®/è¡¨ï¼›X-Perf-Run æ ‡è¯†å…¨é“¾è·¯æ‰“é€šï¼›è§‚æµ‹ç³»ç»Ÿé™é‡‡æ ·ã€‚
	4.	è„šæœ¬é˜²å‘†ï¼šé˜¶æ¢¯åŠ å‹ + æœ€å¤§å¹¶å‘/æ—¶é•¿ï¼›å…³é”®æ­¥éª¤æ–­è¨€ï¼›å…¨å±€é”™è¯¯ç‡/P95 é˜ˆå€¼è‡ªåŠ¨å¤±è´¥ã€‚
	5.	åº”æ€¥æ‹‰é—¸ï¼šè„šæœ¬ Schedulerã€stoptestï¼Œä»¥åŠ CI çš„â€œå¤±è´¥å³ä¸­æ­¢â€ç­–ç•¥ã€‚
	6.	æ¼”ç»ƒï¼šå…ˆåœ¨ å•æ¥å£å°æµé‡ éªŒè¯ï¼Œå†æ‰©å¤§åˆ°ä¸šåŠ¡æµï¼›å…ˆå¹²è·‘ï¼ˆæ— å‰¯ä½œç”¨ï¼‰å†è·‘å†™å…¥åœºæ™¯ã€‚

â¸»

å››ã€ä½ å¯èƒ½ç”¨å¾—ä¸Šçš„ç‰‡æ®µï¼ˆæ±‡æ€»ï¼‰

åœ¨ JMeter DSL ä¸­åšâ€œæ¸è¿› + æ—¶é•¿ + æ–­è¨€ + æŠ¥å‘Š + å®‰å…¨é€€å‡ºâ€

var stats = testPlan(
  httpDefaults().url(System.getProperty("baseUrl")),
  threadGroup()
    .rampToAndHold(50, Duration.ofSeconds(60), Duration.ofMinutes(3))
    .children(
      httpSampler("/api/health"),
      durationAssertion().durationLessThan(2_000),
      responseAssertion().testField(ResponseField.RESPONSE_CODE).equalsTo("200")
    ),
  summaryStats()
).run();

// è‡ªåŠ¨åˆ¤çº¢çº¿ï¼ˆç¤ºä¾‹ï¼‰
if (stats.overall().errorsPercent() > 1.0 || stats.overall().perc95() > 1500) {
  throw new AssertionError("Perf gate failed");
}

Spring Cloud ä¾§ä¸€é”®å…œåº•ï¼ˆResilience4j + Tomcat + Feignï¼‰ï¼šè§ä¸Šä¸€èŠ‚ YAML/Java ç‰‡æ®µï¼Œç›´æ¥ç²˜åˆ° application-perf.yml ä¸é…ç½®ç±»å³å¯ã€‚





