ğŸ§© ä¸€ã€JMeter Java DSL ç®€ä»‹

jmeter-java-dsl æ˜¯ç”± Abstracta å¼€æºçš„ä¸€ä¸ª DSLï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰åº“ï¼Œè®©ä½ ç”¨ Java ä»£ç ç›´æ¥æè¿° JMeter è„šæœ¬ï¼Œè€Œä¸æ˜¯ç»´æŠ¤å¤æ‚çš„ .jmx æ–‡ä»¶ã€‚

å®ƒçš„æ ¸å¿ƒç†å¿µæ˜¯ï¼š

â€œè®©æ€§èƒ½æµ‹è¯•åƒå•å…ƒæµ‹è¯•ä¸€æ ·ç¼–å†™å’Œè¿è¡Œã€‚â€

ä¸»è¦ç‰¹æ€§ï¼š
	â€¢	æ— éœ€ JMeter GUIï¼›
	â€¢	è‡ªåŠ¨ç®¡ç†çº¿ç¨‹ç»„ã€é‡‡æ ·å™¨ã€å®šæ—¶å™¨ã€æ–­è¨€ï¼›
	â€¢	æ”¯æŒæ‰€æœ‰å¸¸è§ JMeter åŠŸèƒ½ï¼›
	â€¢	å¯åœ¨ IDE æˆ– CI ä¸­è¿è¡Œï¼›
	â€¢	å¯ç›´æ¥ç”Ÿæˆ .jmx æ–‡ä»¶å’Œ HTML æŠ¥å‘Šã€‚

â¸»

âš™ï¸ äºŒã€åŸºç¡€ç»“æ„

åœ¨ DSL ä¸­ï¼Œä¸€ä¸ªå®Œæ•´çš„æµ‹è¯•è„šæœ¬é€šå¸¸åŒ…å«ä¸‰å±‚ç»“æ„ï¼š
testPlan(
  threadGroup()
    .children(
       httpSampler("path").method("GET"),
       responseAssertion().containsSubstrings("OK")
    ),
  summaryStats() // æ§åˆ¶å°æ±‡æ€»è¾“å‡º
).run();

å±‚çº§
è¯´æ˜
testPlan()
é¡¶å±‚å®¹å™¨ï¼Œç­‰ä»·äº JMeter çš„ Test Plan
threadGroup()
çº¿ç¨‹ç»„ï¼ˆå¹¶å‘ç”¨æˆ·ã€RampUpã€å¾ªç¯æ¬¡æ•°ï¼‰
.children()
çº¿ç¨‹ç»„å†…çš„è¯·æ±‚ã€é…ç½®ã€å®šæ—¶å™¨ã€æ–­è¨€ç­‰
httpSampler()
è¯·æ±‚å®šä¹‰ï¼ˆURLã€æ–¹æ³•ã€Headerã€Bodyï¼‰
assertion()
å“åº”æ–­è¨€ï¼ˆå†…å®¹ã€æ—¶é•¿ã€çŠ¶æ€ç ï¼‰
summaryStats()
ç»“æœæ±‡æ€»ç›‘å¬å™¨ï¼ˆç­‰ä»· GUI çš„â€œæ±‡æ€»æŠ¥å‘Šâ€ï¼‰


ä¸‰ã€æ ¸å¿ƒç»„ä»¶ä¸æ–¹æ³•è¯¦è§£

1ï¸âƒ£ Test Planï¼ˆæµ‹è¯•è®¡åˆ’ï¼‰
testPlan(children...)         // å®šä¹‰æ•´ä¸ªè®¡åˆ’
testPlan(threads, rampUp, duration) // å¯åŒæ—¶è®¾ç½®çº¿ç¨‹å‚æ•°

è¿˜å¯åµŒå¥—å¤šä¸ª threadGroup æˆ– backendListenerã€‚


ã€‚

â¸»

2ï¸âƒ£ Thread Groupï¼ˆçº¿ç¨‹ç»„ï¼‰

threadGroup()
  .rampToAndHold(200, Duration.ofSeconds(60), Duration.ofMinutes(5)) // 60så†…å‡åˆ°200çº¿ç¨‹å¹¶æŒç»­5åˆ†é’Ÿ
  .children(...);

å…¶ä»–å¯ç”¨æ–¹æ³•ï¼š
threadGroup("name", 100, Duration.ofSeconds(30), children...) // æŒ‡å®šçº¿ç¨‹æ•°ä¸å‡æ¸©æ—¶é—´
rampToAndHold()            // GUI â€œé˜¶æ¢¯å¼åŠ å‹â€
holdFor(Duration.ofMinutes(3))
rampDownTo(0, Duration.ofSeconds(30))

çº¿ç¨‹ç»„æ–¹æ³•å®Œå…¨ç­‰ä»·äº GUI ä¸­çš„ã€Œçº¿ç¨‹ç»„ã€ã€ã€Œå¹¶å‘çº¿ç¨‹ç»„ã€ã€‚

HTTP Samplerï¼ˆè¯·æ±‚ï¼‰

httpSampler("/api/login")
  .method("POST")
  .body("{\"user\":\"admin\",\"pass\":\"123\"}")
  .header("Content-Type", "application/json")
  .header("Authorization", "Bearer token")
  .timeout(Duration.ofSeconds(10));
æˆ–æŒ‡å®šå®Œæ•´ URLï¼š

httpDefaults().url("https://example.com")
httpSampler("/api/health")

é€šè¿‡ httpDefaults() è®¾ç½®å…¨å±€ BaseURLã€Headerã€Cookieã€‚

Config å…ƒä»¶
	â€¢	HTTP Defaults

httpDefaults().url("https://api.test.com")

HTTP Headers

httpHeaders().header("User-Agent", "JMeter-DSL")

CSV Data Set

csvDataSet("data.csv").variableNames("user,password")

Cookies / Cache

httpCookies()
httpCache()


â¸»

5ï¸âƒ£ Timerï¼ˆå®šæ—¶å™¨ï¼‰

constantTimer(200)              // å›ºå®šå»¶è¿Ÿ 200ms
uniformRandomTimer(200, 500)    // éšæœºå»¶è¿Ÿ [200,700]ms
constantThroughputTimer(100)    // ä¿æŒæ’å®šååé‡ 100 RPS

6ï¸âƒ£ Controllersï¼ˆé€»è¾‘æ§åˆ¶å™¨ï¼‰
ifController("vars.get('token') != null")
  .children(httpSampler("/secured"))

loopController(5)
  .children(httpSampler("/ping"))

ç­‰ä»·äº GUI ä¸­çš„ If Controllerã€Loop Controller ç­‰ã€‚


7ï¸âƒ£ Pre/Post Processorsï¼ˆå‰åç½®å¤„ç†å™¨ï¼‰

jsr223PreProcessor("vars.put('ts', System.currentTimeMillis()+'')")
jsr223PostProcessor("log.info('Response:' + prev.getResponseDataAsString())")

regexExtractor("token", "\"token\":\"(.+?)\"") // æå– JSON ä¸­çš„ token
jsonExtractor("id", "$.data.id")


â¸»

8ï¸âƒ£ Assertionsï¼ˆæ–­è¨€ï¼‰

responseAssertion()
  .containsSubstrings("success") // å†…å®¹æ–­è¨€
  .testField(ResponseField.RESPONSE_CODE)
  .equalsTo("200")

durationAssertion().durationLessThan(2000) // å“åº”æ—¶é—´ < 2s

9ï¸âƒ£ Listenersï¼ˆç›‘å¬å™¨ï¼‰

summaryStats()                             // æ§åˆ¶å°èšåˆæŠ¥å‘Š
backendListener(BackendListenerType.INFLUX_DB_V2)
  .url("http://influxdb:8086")
  .organization("demo")
  .bucket("jmeter")
  .token("my-token");

æˆ–è¾“å‡ºå®Œæ•´ HTML æŠ¥å‘Šï¼š

var stats = testPlan(...).run();
stats.saveHtmlReport("target/jmeter-report");

ğŸ”Ÿ æ‰§è¡Œä¸ç»“æœå¯¹è±¡

var stats = testPlan(...).run();
System.out.println("Total samples: " + stats.overall().samplesCount());
System.out.println("Errors: " + stats.overall().errorsCount());
System.out.println("Throughput: " + stats.overall().throughput());

ç»“æœå¯¹è±¡ stats å…è®¸ï¼š
	â€¢	stats.overall() â†’ å…¨å±€ç»Ÿè®¡
	â€¢	stats.byLabel("æ¥å£å") â†’ å•æ¥å£ç»Ÿè®¡
	â€¢	å¯¼å‡ºæŠ¥å‘Šï¼šstats.saveAsJtl("results.jtl")


äº”ã€å®Œæ•´ç¤ºä¾‹ï¼ˆç­‰ä»·äº GUI å¤åˆè„šæœ¬ï¼‰

import static us.abstracta.jmeter.javadsl.JmeterDsl.*;
import java.time.Duration;

public class DslPerfTest {
  public static void main(String[] args) throws Exception {
    var stats = testPlan(
        httpDefaults().url("https://api.example.com"),
        threadGroup("User Flow", 100, Duration.ofSeconds(30))
            .rampToAndHold(100, Duration.ofSeconds(30), Duration.ofMinutes(3))
            .children(
                csvDataSet("users.csv").variableNames("user,password"),
                httpSampler("/login")
                    .method("POST")
                    .body("{\"user\":\"${user}\",\"password\":\"${password}\"}")
                    .header("Content-Type", "application/json"),
                jsonExtractor("token", "$.token"),
                ifController("vars.get('token') != null")
                    .children(
                        httpSampler("/data")
                            .header("Authorization", "Bearer ${token}")
                    ),
                uniformRandomTimer(200, 500),
                responseAssertion().containsSubstrings("OK")
            ),
        summaryStats()
    ).run();

    stats.saveAsJtl("target/jmeter/results.jtl");
    stats.saveHtmlReport("target/jmeter/report");
  }
}

âœ… è¿™æ®µä»£ç ç­‰ä»·äº JMeter GUI è„šæœ¬ï¼š
	â€¢	ç”¨æˆ·ç™»å½• + æå– tokenï¼›
	â€¢	æºå¸¦ token è°ƒç”¨ä¸šåŠ¡æ¥å£ï¼›
	â€¢	éšæœºç­‰å¾…ï¼›
	â€¢	éªŒè¯å“åº”ä¸­åŒ…å« â€œOKâ€ï¼›
	â€¢	è¾“å‡ºèšåˆæŠ¥å‘Šä¸ HTMLã€‚

å…­ã€å®æˆ˜ç”¨æ³•å»ºè®®

ç›®æ ‡
æ–¹æ³•
å¿«é€Ÿç¼–å†™å°åœºæ™¯
åœ¨å•å…ƒæµ‹è¯•ç±»ä¸­ç”¨ @Test + DSL
CI è‡ªåŠ¨åŒ–å‹æµ‹
mvn test -Pperf
å‹æµ‹ç»“æœå…¥åº“
ç”¨ stats.overall() æå–æŒ‡æ ‡å†™å…¥ Prometheus/DB
å…¼å®¹ GUI
.saveAsJmx("plan.jmx") å¯¼å‡ºä¸º JMeter å¯è§†åŒ–æ–‡ä»¶
å®æ—¶ç›‘æ§
backendListener(INFLUX_DB_V2) + Grafana



DSL ä¸ GUI å¯¹ç…§è¡¨

GUI å…ƒä»¶
Java DSL å¯¹åº”æ–¹æ³•
Test Plan
testPlan()
Thread Group
threadGroup(), rampToAndHold()
HTTP Request
httpSampler()
CSV Data Set Config
csvDataSet()
Uniform Random Timer
uniformRandomTimer()
Constant Throughput Timer
constantThroughputTimer()
Response Assertion
responseAssertion()
If Controller
ifController()
JSR223 Pre/Post Processor
jsr223PreProcessor(), jsr223PostProcessor()
Regex Extractor
regexExtractor()
Summary Report
summaryStats()
Backend Listener
backendListener()



